<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeetUpOur</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <Style>
    body {
    background-color: #5affb8;
    font-family: "Comfortaa", sans-serif;
}

h1, h2, h3, h4, h5, h6, p, ul, ol, blockquote {
    margin: 0;
    padding: 0;
}

.container {
    display: flex;
    flex-direction: column;
    align-items: center; 
    justify-content: center;
}

.intro-title {
    margin: 20px 0 40px;
}

.basic-text {
    padding: 0 0 20px;
}

.content-section {
    border-radius: 30px;
    padding: 20px;
    box-sizing: border-box;
    max-width: 540px;
}

.content-section_theme_yellow {
    background-color:rgb(251, 255, 136);
    border-radius: 30px;
    box-shadow: 12px 12px 2px 1px rgb(255, 142, 240);
    padding: 20px;
}

.meet-start {
    margin-top: 100px;
    text-align: center;
    
}

.start-title {
    margin-bottom: 50px;
}

.content-section_theme_white {
    background-color: rgb(255, 255, 255);
    border-radius: 30px;
    padding: 20px;
    border: 2px solid black;
}

.button-start {
    background-color: #b0ffde;
    border-radius: 15px;
    width: 200px;
    height: 50px;
    font-size: 30px;
    font-weight: 700;
    transition: background-color 0.2s ease;
}

.button-start:active {
    background-color: #32a072;
}

.description__form {
    margin-top: 30px;
    margin-bottom: 100px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    
}

.form__accent {
    margin-top: 40px;
    background: #ffffff;
    border: #d6d659;
    padding: 20px 100px;
}

.choice {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 10px 0px;
}

.first_choice, .second_choice, .user-input {
    display: none;
    margin-top: 100px;
}

.checkbox_accent {
    display: none; /* –°–∫—Ä—ã—Ç—å —Å–∞–º —á–µ–∫–±–æ–∫—Å */
}

.checkbox_accent + label {
    display: inline-block;
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
    background-color: #9bebff;
    text-align: center;
}

.checkbox_accent:checked + label  {
    background-color: #acd1da; 
    color: #fff;
}




.matching-users {
    margin-top: 100px;
    text-align: center;
    
}

    </Style>     
</head>
<body> 
   
    <main> 
        <div class="container"> 


            <!-- –ë–∞–∑–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤ --> 
            <section class="user-info content-section content-section_theme_yellow"> 
                <h1 class="intro-title">MeetUp</h1> 
                <p class="basic-text" id="usernameDisplay">@</p> 
                <p class="basic-text" id="test"> 
                –î–∞–≤–∞–π—Ç–µ –∏—Å–∫–∞—Ç—å –¥—Ä—É–≥–∞ –¥—Ä—É–≥–∞ –≤–º–µ—Å—Ç–µ, –≤–µ–¥—å —ç—Ç–æ –∫—Ä—É—Ç–æ!üí• 
                </p> 
            </section> 


            <!-- –ö–Ω–æ–ø–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é. –ï—Å–ª–∏ —é–∑–µ—Ä –µ—Å—Ç—å –≤ –ë–î, —Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –Ω–∞ —ç–∫—Ä–∞–Ω –ø–æ–∏—Å–∫–∞, 
                –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ –Ω–∞ —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ç–µ–≥–æ–≤ --> 
            <section class="meet-start content-section content-section_theme_white"> 
                <h2 class="start-title">–î–∞–≤–∞–π—Ç–µ –ø—Ä–∏—Å—Ç—É–ø–∏–º!</h2> 
                <button class="button-start" id="button-starts">–ù–∞—á–Ω–µ–º!</button> 
            </section> 


            <!-- –°–µ–∫—Ü–∏—è —Å –≤—ã–±–æ—Ä–æ–º —Ç–µ–≥–æ–≤, –æ–Ω–∞ –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è –∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞—Ö–æ–¥–µ –∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–µ–≥–æ–≤ --> 
            <section class="first_choice content-section content-section_theme_yellow"> 
                <section class="description__form"> 
                    <h2 class="input-title">–û–ø–∏—à–∏—Ç–µ —Å–µ–±—è!:</h2> 
                    <input class="form__accent" type="text" id="descriptionInput" placeholder="–¢—É—Ç –≤—ã –æ–ø–∏—Å—ã–≤–∞–µ—Ç–µ —Å–µ–±—è!"> 
                </section> 
                <h2 class="start-title">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è –≤–∞–º —Ç–µ–º—ã! –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Å –ø–æ–¥–±–æ—Ä–æ–º –ª—é–¥–µ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å. </h2> 
                <form class="choice"> 
                    <input class="checkbox_accent cinema" type="checkbox" id="option1" name="options[]" value="–ö–∏–Ω–æ"> 
                    <label for="option1">–ö–∏–Ω–æ</label><br> 
                 
                    <input class="checkbox_accent literature" type="checkbox" id="option2" name="options[]" value="–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞"> 
                    <label for="option2">–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</label><br> 
                 
                    <input class="checkbox_accent sport" type="checkbox" id="option3" name="options[]" value="–ú—É–∑—ã–∫–∞"> 
                    <label for="option3">–ú—É–∑—ã–∫–∞</label><br> 
 
                    <input class="checkbox_accent art" type="checkbox" id="option4" name="options[]" value="–ò—Å–∫—É—Å—Å—Ç–≤–æ"> 
                    <label for="option4">–ò—Å–∫—É—Å—Å—Ç–≤–æ</label><br> 
 
                    <input class="checkbox_accent sport" type="checkbox" id="option5" name="options[]" value="–°–ø–æ—Ä—Ç"> 
                    <label for="option5">–°–ø–æ—Ä—Ç</label><br> 
 
                    <input class="checkbox_accent sport" type="checkbox" id="option6" name="options[]" value="–ì–æ—Ç–æ–≤–∫–∞"> 
                    <label for="option6">–ì–æ—Ç–æ–≤–∫–∞</label><br> 
 
                    <input class="checkbox_accent sport" type="checkbox" id="option7" name="options[]" value="–í–∏–¥–µ–æ –∏–≥—Ä—ã"> 
                    <label for="option7">–í–∏–¥–µ–æ –∏–≥—Ä—ã</label><br> 
 
                    <input class="checkbox_accent sport" type="checkbox" id="option8" name="options[]" value="–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏"> 
                    <label for="option8">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</label><br> 
 
                    <input class="checkbox_accent sport" type="checkbox" id="option9" name="options[]" value="–¢–∞–Ω—Ü—ã"> 
                    <label for="option9">–¢–∞–Ω—Ü—ã</label><br> 
 
                    <input class="checkbox_accent sport" type="checkbox" id="option10" name="options[]" value="–ú–æ–¥–∞"> 
                    <label for="option10">–ú–æ–¥–∞</label><br> 
                 
                    <input type="submit" value="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å" id="TagsChoice"> 
                </form>                
            </section>


            <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥–æ–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <section class="matching-users content-section content-section_theme_white" style="display: none;">
                <h2 class="start-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç —Å—Ö–æ–∂–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã!</h2>
                <div id="matchingUser">
                    <p id="userInfo"></p>
                    <button class="button-skip" id="skipButton">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
                </div>
            </section> 
        </div> 
    </main> 
        <script>
        document.addEventListener("DOMContentLoaded", function() {

        const defaultUrl = "https://6ca0-83-142-12-120.ngrok-free.app";
        const tg = window.Telegram.WebApp; 

        document.getElementById('usernameDisplay').textContent = `@${tg.initDataUnsafe.user.username}`;

        //–í—ã–¥–µ–ª—è–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∞–π–¥–∏ –ø–æ –∫–æ—Ç–æ—Ä—ã–º –±—É–¥—É—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å—Å—è —Ñ—É–Ω–∫—Ü–∏–∏
        const sendUserData = document.getElementById('button-starts');
        const TagsChoice= document.getElementById('TagsChoice');
        
        //–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é
        async function fetchData(endpoint, data) {
            try {
                const response = await axios.post(`${defaultUrl}/${endpoint}`, data);
                return response.data;
            } catch (error) {
                console.log(error);
            }
        }


        async function deleteData(endpoint, data) {
            try {
                const response = await axios.delete(`${defaultUrl}/${endpoint}`);
                return response.data;
            } catch (error) {
                console.log(error);
            }
        }

        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é. –ï—Å–ª–∏ —é–∑–µ—Ä –µ—Å—Ç—å –≤ –ë–î, —Ç–æ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø–æ–∏—Å–∫ –ª—é–¥–µ–π,–µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ –Ω–∞ —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ç–µ–≥–æ–≤
        async function sendUserDataToServer() 
        {
            try {
                    const userId = tg.initDataUnsafe.user.id;
                    const firstName = tg.initDataUnsafe.user.first_name;
                    const username = tg.initDataUnsafe.user.username;
                    const allowsWriteToPm = tg.initDataUnsafe.user.allows_write_to_pm;
                
                const response = await fetchData('send-user-data', {
                    id: userId,
                    first_name: firstName,
                    username: username,
                    allows_write_to_pm: allowsWriteToPm
                });

                await deleteOldEncounters();

                if (response.message === 'User already exists') {
                    MatchingUsers(userId) 
                } 
                else {
    
                document.querySelector('.meet-start').style.display = 'none';
                document.querySelector('.first_choice').style.display = 'block';
            }

                
            } catch (error) {
                console.error('Error sending data to server:', error);
            }
        }
        
        async function deleteOldEncounters() 
        {
        try {
            const response = await deleteData('delete-encounters');
            console.log(response);
        } catch (error) {
            console.error('Error deleting old encounters:', error);
        }
        }


        sendUserData.addEventListener('click', sendUserDataToServer);

        
        TagsChoice.addEventListener('click', function(event) {
            event.preventDefault();
            const description = document.getElementById('descriptionInput').value;
            const checkboxes = document.querySelectorAll('.first_choice input[type="checkbox"]:checked');
            const selectedOptions = Array.from(checkboxes).map(checkbox => checkbox.value);
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏—è –∏ —á–µ–∫–±–æ–∫—Å–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetchData('send-description-and-options', {
                user_id: tg.initDataUnsafe.user.id, 
                description: description,
                tags: selectedOptions 

                }).then(response => {
                
                document.querySelector('.first_choice').style.display = 'none';
                
            }).catch(error => {
                console.error('Error sending data:', error);
            });
        });


        let currentIndex = 0;
        let matchingUsers = [];

        async function MatchingUsers(userId) {
        try {
            const response = await fetchData('find-matches', {
                id: userId,
            });

            matchingUsers = response.matches;
            if (matchingUsers.length > 0) {
                currentIndex = 0;
                showCurrentUser();
                document.querySelector('.meet-start').style.display = 'none';
                document.querySelector('.matching-users').style.display = 'block';
            } else {
                document.querySelector('.meet-start').style.display = 'none';
                document.querySelector('.matching-users').style.display = 'block';
                document.getElementById('userInfo').textContent = '–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
            }
            } catch (error) {
                console.error('Error fetching matching users:', error);
            }
            }


            function showCurrentUser() 
            {
            const userElement = document.getElementById('userInfo');
            if (currentIndex < matchingUsers.length) {
                const user = matchingUsers[currentIndex];
                userElement.textContent = JSON.stringify(user);
            } else {
                userElement.textContent = '–ù–µ—Ç –±–æ–ª—å—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
            }
            }

            async function addSkippedUserToDB(encountered_user_id) {
                try {
                    const response = await fetchData('skip-user', {
                        user_id: tg.initDataUnsafe.user.id,
                        encountered_user_id: encountered_user_id,
                    });
                    console.log(response); 
                } catch (error) {
                    console.error('Error adding skipped user to database:', error);
                }
            }

        skipButton.addEventListener('click', async () => {
        const user = matchingUsers[currentIndex];
        await addSkippedUserToDB(user.encountered_user_id);
        currentIndex++;
        showCurrentUser();
        });

        
        });
        </script>   
    </body>
</html>